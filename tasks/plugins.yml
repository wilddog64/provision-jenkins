---
- name: create jenkins update folder
  file:
    path: "{{ jenkins_home }}/updates"
    owner: jenkins
    group: jenkins
    mode: 0755
    state: directory
  register: jenkins_plugins_folder_create

- name: update jenkins plugin data
  shell: curl -L https://updates.jenkins-ci.org/update-center.json | sed '1d;$d' > "{{ jenkins_home }}/updates/default.json"
  args:
    creates: "{{ jenkins_home }}/updates/default.json"

- name: install curl
  apt:
   pkg: curl
   state: installed

- name: update permissions for default.json
  file:
    path: "{{ jenkins_home }}/update/default.json"
    owner: jenkins
    group: jenkins
    mode: 0755
  when:  jenkins_plugins_folder_create.changed

- name: download jenkins-cli.jar file
  get_url:
    url: "http://{{ jenkins_hostname }}:{{ jenkins_http_port }}{{ jenkins_url_prefix }}/jnlpJars/jenkins-cli.jar"
    dest: "{{ jenkins_jar_location }}"
  register: jarfile_get
  until: "'OK' in jarfile_get.msg or 'file already exists' in jarfile_get.msg"
  retries: 5
  delay: 10

- name: install jenkins plugins
  command: >
     java -jar {{ jenkins_jar_location }} -s http://{{ jenkins_hostname }}:{{ jenkins_http_port }}{{ jenkins_url_prefix | default('') }}/
     install-plugin {{ item }}
     --username {{ jenkins_admin_user }}
     --password {{ jenkins_admin_password }}
     creates="{{ jenkins_home }}/plugins/{{ item }}.jpi"
  with_items: "{{ jenkins_plugins }}"
  when: jenkins_admin_password != ""
  notify: restart Jenkins
